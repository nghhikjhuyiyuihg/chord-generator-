<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחולל אקורדים לפי סולם</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f8;
      direction: rtl;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    label, select, input[type="text"], button {
      font-size: 16px;
      width: 100%;
      margin: 8px 0;
    }

    select, input[type="text"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 20px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-top: 10px;
    }

    button:hover {
      background: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
      text-align: center;
    }

    th {
      background: #f0f0f0;
      font-weight: bold;
    }

    td input {
      width: 100%;
      border: none;
      background: none;
      text-align: center;
      font-size: 16px;
      padding: 0;
    }

    .capo-box {
      margin-top: 30px;
      background: #eef2f7;
      padding: 10px;
      border-radius: 8px;
    }

    /* רספונסיבי - כרטיסים לנייד במקום טבלה */
    @media (max-width: 600px) {
      h1 {
        font-size: 20px;
      }

      select, input[type="text"], button, label {
        font-size: 14px;
        padding: 8px;
      }

      table {
        display: none; /* מסתירים טבלה בנייד */
      }

      /* יוצרים כרטיסים במקומה */
      #chordTable tr {
        display: block;
        margin-bottom: 15px;
        padding: 15px;
        background: #fafafa;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        text-align: right;
      }

      #chordTable tr td {
        display: block;
        padding: 4px 0;
        border: none;
        white-space: normal; /* מאפשר שורות ארוכות */
      }

      #chordTable tr td input {
        font-size: 14px;
        padding: 4px 0;
        width: 100%;
        text-align: right;
        border: none;
        background: none;
      }

      /* תוויות לפני כל שדה בכרטיס */
      #chordTable tr td::before {
        content: attr(data-label);
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
        color: #333;
      }

      /* הקטנת גודל הכותרות והכפתורים */
      .capo-box {
        padding: 8px;
        font-size: 14px;
      }
      button {
        padding: 8px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>מחולל אקורדים לפי סולם</h1>

    <label for="scaleSelect">בחר סולם:</label>
    <select id="scaleSelect" onchange="updateTable()">
      <option value="C">C</option>
      <option value="Am">Am</option>
      <option value="E#m">E#m</option>
      <option value="Bb">Bb</option>
      <option value="B#">B#</option>
      <option value="F#m">F#m</option>
    </select>

    <table>
      <thead>
        <tr>
          <th>דרגה</th>
          <th>אקורד</th>
          <th>תפקיד משוער</th>
        </tr>
      </thead>
      <tbody id="chordTable"></tbody>
    </table>

    <div class="capo-box">
      <h3>חשב מיקום קאפו 🎸</h3>
      <label for="fromScale">סולם שאתה מנגן בו:</label>
      <select id="fromScale"></select>
      <label for="toScale">סולם שאתה רוצה שישמע:</label>
      <select id="toScale"></select>
      <button onclick="calculateCapo()">חשב</button>
      <p id="capoResult"></p>
    </div>
  </div>

  <script>
    const chromatic = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    // מפה לשינוי תווים נדירים ל-enharmonic מקובל
    const enharmonicMap = {
      "Bb": "A#", "Eb": "D#", "Ab": "G#", "Db": "C#", "Gb": "F#",
      "Cb": "B", "Fb": "E", "E#": "F", "B#": "C",
      "Bbm": "A#m", "Ebm": "D#m", "Abm": "G#m", "Dbm": "C#m", "Gbm": "F#m",
      "Cbm": "Bm", "Fbm": "Em", "E#m": "Fm", "B#m": "Cm"
    };

    // צעדים לסולמות מז'ור ומינור (ברירת מחדל)
    const scaleSteps = {
      major: [2, 2, 1, 2, 2, 2, 1],
      minor: [2, 1, 2, 2, 1, 2, 2],
    };

    // תפקידים לפי דרגה במז'ור (ברירת מחדל)
    const degreeRolesMajor = [
      "מרכז השיר",
      "משמש לעומק ומעבר",
      "צליל רגשי",
      "אקורד מעבר",
      "אקורד חזק לפני חזרה",
      "אקורד עצוב/חילופי בסיס",
      "לא יציב, יוצר מתח"
    ];

    // חשבון מרווח חצאי טונים בין תווים (כלומר אינטרוולים)
    function halfToneDistance(from, to) {
      const fromIndex = chromatic.indexOf(from);
      const toIndex = chromatic.indexOf(to);
      if (fromIndex === -1 || toIndex === -1) return null;
      return (toIndex - fromIndex + 12) % 12;
    }

    // יוצר סולם מחוץ לטוניקה (root) ולסוג סולם
    function generateScale(rootNote, type="major") {
      // המרת enharmonic אם צריך
      let baseNote = enharmonicMap[rootNote] || rootNote;
      let noteRoot = baseNote.replace(/m$/, "");
      const isMinor = rootNote.endsWith("m") || type === "minor";

      const steps = isMinor ? scaleSteps.minor : scaleSteps.major;
      const scaleNotes = [];

      let idx = chromatic.indexOf(noteRoot);
      if (idx === -1) {
        return null; // לא תקין
      }
      scaleNotes.push(chromatic[idx]);

      for (let step of steps) {
        idx = (idx + step) % chromatic.length;
        scaleNotes.push(chromatic[idx]);
      }

      // scaleNotes עכשיו 8 תווים (אוקטבה), אבל צריך רק 7
      scaleNotes.pop();

      return scaleNotes;
    }

    // סיווג אקורד לפי המרווחים בין התווים בטריאדה (3 תווים)
    function classifyChord(triad) {
      if (triad.length < 3) return "לא מוגדר";

      // המרת enharmonic:
      const root = enharmonicMap[triad[0]] || triad[0];
      const third = enharmonicMap[triad[1]] || triad[1];
      const fifth = enharmonicMap[triad[2]] || triad[2];

      const interval1 = halfToneDistance(root, third);
      const interval2 = halfToneDistance(third, fifth);

      if (interval1 === 4 && interval2 === 3) return "Major";
      if (interval1 === 3 && interval2 === 4) return "minor";
      if (interval1 === 3 && interval2 === 3) return "diminished";
      if (interval1 === 4 && interval2 === 4) return "augmented";

      return "לא מוגדר";
    }

    // מחזיר אקורד בטריאדה מסולם ודרגה
    function getChordFromScale(scaleNotes, degree) {
      const root = scaleNotes[degree];
      // אקורד הוא טריאדה: root + next + next after that (מעגלי)
      const third = scaleNotes[(degree + 2) % scaleNotes.length];
      const fifth = scaleNotes[(degree + 4) % scaleNotes.length];

      const chordType = classifyChord([root, third, fifth]);

      const suffix = chordType === "minor" ? "m" : chordType === "diminished" ? "°" : chordType === "augmented" ? "+" : "";

      return root + suffix;
    }

    function updateTable() {
      const scaleSelect = document.getElementById("scaleSelect");
      const scale = scaleSelect.value.trim();

      // החלט איזה סוג סולם: אם מסתיים ב-m = מינור, אחרת מז'ור (אפשר להרחיב)
      const scaleType = scale.endsWith("m") ? "minor" : "major";

      const scaleNotes = generateScale(scale, scaleType);
      const tableBody = document.getElementById("chordTable");
      tableBody.innerHTML = "";

      if (!scaleNotes) {
        tableBody.innerHTML = "<tr><td colspan='3'>סולם לא חוקי</td></tr>";
        return;
      }

      const degrees = ["I", "II", "III", "IV", "V", "VI", "VII"];

      degrees.forEach((deg, i) => {
        const tr = document.createElement("tr");

        const degreeCell = document.createElement("td");
        degreeCell.innerText = deg;
        tr.appendChild(degreeCell);

        const chordCell = document.createElement("td");
        chordCell.innerText = getChordFromScale(scaleNotes, i);
        tr.appendChild(chordCell);

        const roleCell = document.createElement("td");
        roleCell.innerText = degreeRolesMajor[i] || "";
        tr.appendChild(roleCell);

        tableBody.appendChild(tr);
      });
    }

    // קאפו - פונקציה מתוקנת
    function calculateCapo() {
      const from = document.getElementById("fromScale").value;
      const to = document.getElementById("toScale").value;

      // השתמש בשם המקורי בלי toUpperCase
      const enharmonicNorm = {
        "Bb": "A#", "Eb": "D#", "Ab": "G#", "Db": "C#", "Gb": "F#",
        "Cb": "B",  "Fb": "E",  "E#": "F",  "B#": "C"
      };

      const fromNorm = enharmonicNorm[from] || from;
      const toNorm = enharmonicNorm[to] || to;

      const fromIndex = chromatic.indexOf(fromNorm);
      const toIndex = chromatic.indexOf(toNorm);

      if (fromIndex === -1 || toIndex === -1) {
        document.getElementById("capoResult").innerText = "אירעה שגיאה בחישוב הקאפו.";
        return;
      }

      const up = (toIndex - fromIndex + 12) % 12;
      const down = (fromIndex - toIndex + 12) % 12;
      const diff = up <= down ? up : -down;

      const result = diff === 0
        ? "אין צורך בקאפו - אותו סולם."
        : diff > 0
          ? `כדי שנשמע כמו ${to}, שים קאפו על סריג ${diff}`
          : `כדי שנשמע כמו ${to}, הורד ${Math.abs(diff)} סריגים (או עבור לסולם נמוך יותר)`;

      document.getElementById("capoResult").innerText = result;
    }

    // טעינה ראשונית - ממלא גם את תפריטי קאפו
    window.onload = () => {
      const scaleSelect = document.getElementById("scaleSelect");
      const fromSelect = document.getElementById("fromScale");
      const toSelect = document.getElementById("toScale");

      // מלא תפריטים בקאפו רק עם סולמות מז'ור ללא מינור (אפשר להרחיב אם רוצים)
      ["C","G","D","A","E","F","Bb","Eb","Ab","Db","Gb","B","F#","C#"].forEach(scale => {
        let optFrom = document.createElement("option");
        optFrom.value = optFrom.text = scale;
        fromSelect.appendChild(optFrom);

        let optTo = document.createElement("option");
        optTo.value = optTo.text = scale;
        toSelect.appendChild(optTo);
      });

      updateTable();
    };
  </script>
</body>
</html>
